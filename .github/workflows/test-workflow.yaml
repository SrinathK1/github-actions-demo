name: Learn-GitHub-Actions-With-Secrets

on:
  push:
    branches: [master, dev, feature/*]
  pull_request:
    branches: [master, dev]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - stage
          - prod
  schedule:
    - cron: '0 3 * * *'
  workflow_run:
    workflows: ["Build Workflow"]
    types: [completed]

# =========================
# Global Environment Variables
# =========================
env:
  APP_NAME: MySampleApp
  REGION: us-east-1
  LOG_LEVEL: info

jobs:
  # -------------------------
  # 1️⃣ Job: Code Validation
  # -------------------------
  code-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        run: echo "Checking out code for $APP_NAME..."

      - name: Lint Code
        run: echo "Running linter at log level $LOG_LEVEL"

      - name: Static Code Analysis
        run: echo "Performing static analysis on $APP_NAME"

  # -------------------------
  # 2️⃣ Job: Build & Test
  # -------------------------
  build-and-test:
    runs-on: ubuntu-latest
    needs: code-check
    steps:
      - name: Build Application
        run: echo "Building application in region $REGION"

      - name: Run Unit Tests
        run: echo "Running unit tests..."

      - name: Use Repo Secret
        run: echo "Using secret API key safely (hidden)"
        env:
          API_KEY: ${{ secrets.REPO_API_KEY }}

      - name: Use Environment Secret
        env:
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: echo "Environment secret (DB_PASSWORD) loaded successfully but not displayed."

  # -------------------------
  # 3️⃣ Job: Package & Upload
  # -------------------------
  package:
    runs-on: ubuntu-latest
    needs: build-and-test
    steps:
      - name: Package Artifact
        run: echo "Packaging build for $APP_NAME"

      - name: Upload Artifact
        run: echo "Uploading artifact to S3 bucket using AWS credentials"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      - name: Confirm Secret Usage
        run: echo "AWS credentials are configured and masked automatically by GitHub."

  # -------------------------
  # 4️⃣ Job: Deploy (Manual Approval)
  # -------------------------
  deploy:
    runs-on: ubuntu-latest
    needs: package
    environment:
      name: production
    env:
      DEPLOY_REGION: us-west-2
      DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
    steps:
      - name: Wait for Approval
        run: echo "Waiting for manual approval for deployment..."

      - name: Deploy to Production
        run: echo "Deploying $APP_NAME to $DEPLOY_REGION using deployment token..."

      - name: Post Deployment
        run: echo "Deployment verification complete!"
